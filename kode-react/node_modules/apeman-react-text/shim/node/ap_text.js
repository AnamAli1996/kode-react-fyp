/**
 * apeman react package text component.
 * @class ApText
 */

'use strict';

Object.defineProperty(exports, "__esModule", {
  value: true
});

var _assign = require('babel-runtime/core-js/object/assign');

var _assign2 = _interopRequireDefault(_assign);

var _extends2 = require('babel-runtime/helpers/extends');

var _extends3 = _interopRequireDefault(_extends2);

var _getIterator2 = require('babel-runtime/core-js/get-iterator');

var _getIterator3 = _interopRequireDefault(_getIterator2);

var _getPrototypeOf = require('babel-runtime/core-js/object/get-prototype-of');

var _getPrototypeOf2 = _interopRequireDefault(_getPrototypeOf);

var _classCallCheck2 = require('babel-runtime/helpers/classCallCheck');

var _classCallCheck3 = _interopRequireDefault(_classCallCheck2);

var _createClass2 = require('babel-runtime/helpers/createClass');

var _createClass3 = _interopRequireDefault(_createClass2);

var _possibleConstructorReturn2 = require('babel-runtime/helpers/possibleConstructorReturn');

var _possibleConstructorReturn3 = _interopRequireDefault(_possibleConstructorReturn2);

var _inherits2 = require('babel-runtime/helpers/inherits');

var _inherits3 = _interopRequireDefault(_inherits2);

var _react = require('react');

var _react2 = _interopRequireDefault(_react);

var _reactDom = require('react-dom');

var _reactDom2 = _interopRequireDefault(_reactDom);

var _classnames = require('classnames');

var _classnames2 = _interopRequireDefault(_classnames);

var _bwindow = require('bwindow');

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

/** @lends ApText */
var ApText = function (_Component) {
  (0, _inherits3.default)(ApText, _Component);

  // --------------------
  // Specs
  // --------------------
  function ApText(props) {
    (0, _classCallCheck3.default)(this, ApText);

    var _this = (0, _possibleConstructorReturn3.default)(this, (ApText.__proto__ || (0, _getPrototypeOf2.default)(ApText)).call(this, props));

    var s = _this;
    s.state = {
      suggesting: false,
      candidates: null,
      selectedCandidate: null
    };
    var methodsToBind = ['handleFocus', 'handleKeyUp', 'handleChange', 'handleBlur', 'handleKeyDown', 'handleCandidate'];
    var _iteratorNormalCompletion = true;
    var _didIteratorError = false;
    var _iteratorError = undefined;

    try {
      for (var _iterator = (0, _getIterator3.default)(methodsToBind), _step; !(_iteratorNormalCompletion = (_step = _iterator.next()).done); _iteratorNormalCompletion = true) {
        var name = _step.value;

        s[name] = s[name].bind(s);
      }
    } catch (err) {
      _didIteratorError = true;
      _iteratorError = err;
    } finally {
      try {
        if (!_iteratorNormalCompletion && _iterator.return) {
          _iterator.return();
        }
      } finally {
        if (_didIteratorError) {
          throw _iteratorError;
        }
      }
    }

    s.handleClickForOutside = s.handleClickForOutside.bind(s);
    return _this;
  }

  (0, _createClass3.default)(ApText, [{
    key: 'render',
    value: function render() {
      var s = this;
      var state = s.state,
          props = s.props;
      var id = props.id,
          name = props.name,
          placeholder = props.placeholder,
          autoComplete = props.autoComplete,
          autoFocus = props.autoFocus,
          className = props.className,
          value = props.value,
          rows = props.rows;

      var hasVal = !!value;

      var multiline = rows && rows > 1;

      var candidates = state.candidates,
          selectedCandidate = state.selectedCandidate,
          suggesting = state.suggesting;


      var textHandlers = {
        onFocus: s.handleFocus,
        onKeyUp: s.handleKeyUp,
        onChange: s.handleChange,
        onBlur: s.handleBlur,
        onKeyDown: s.handleKeyDown
      };
      var candidateHandlers = {
        onClick: s.handleCandidate
      };

      return _react2.default.createElement(
        'span',
        { className: (0, _classnames2.default)('ap-text-wrap', { 'ap-text-wrap-empty': !hasVal }) },
        _react2.default.createElement(ApText.Text, (0, _extends3.default)({ id: id, name: name, value: value, placeholder: placeholder, className: className, autoFocus: autoFocus, autoComplete: autoComplete, multiline: multiline, rows: rows }, {
          handlers: textHandlers
        })),
        _react2.default.createElement(ApText.CandidateList, (0, _extends3.default)({ suggesting: suggesting, candidates: candidates, selectedCandidate: selectedCandidate, multiline: multiline }, {
          handlers: candidateHandlers
        }))
      );
    }
  }, {
    key: 'componentDidMount',
    value: function componentDidMount() {
      var s = this;
      var body = (0, _bwindow.get)('document.body');
      body.addEventListener('click', s.handleClickForOutside);
    }
  }, {
    key: 'componentWillUnmount',
    value: function componentWillUnmount() {
      var s = this;
      var body = (0, _bwindow.get)('document.body');
      body.removeEventListener('click', s.handleClickForOutside);
    }

    // --------------------
    // Custom
    // --------------------

  }, {
    key: 'handleCandidate',
    value: function handleCandidate(e) {
      var s = this;
      var props = s.props;

      e.target.value = e.target.value || e.target.dataset.value;
      s.setState({ suggesting: false });
      if (props.onChange) {
        props.onChange(e);
      }
    }
  }, {
    key: 'handleFocus',
    value: function handleFocus(e) {
      var s = this;
      var props = s.props;

      s.setState({ suggesting: true });
      s.updateCandidates();
      if (props.onFocus) {
        props.onFocus(e);
      }
    }
  }, {
    key: 'handleChange',
    value: function handleChange(e) {
      var s = this;
      var props = s.props;

      s.setState({ suggesting: true });
      if (props.onChange) {
        props.onChange(e);
      }
    }
  }, {
    key: 'handleBlur',
    value: function handleBlur(e) {
      var s = this;
      var props = s.props;


      if (props.onBlur) {
        props.onBlur(e);
      }
    }
  }, {
    key: 'handleKeyUp',
    value: function handleKeyUp(e) {
      var s = this;
      var props = s.props;

      s.updateCandidates();
      if (props.onKeyUp) {
        props.onKeyUp(e);
      }
    }
  }, {
    key: 'handleClickForOutside',
    value: function handleClickForOutside(e) {
      var s = this;
      var node = _reactDom2.default.findDOMNode(s);
      if (!node) {
        return;
      }
      var contained = node.contains(e.target);
      if (!contained) {
        s.outsideDidTap(e);
      }
    }
  }, {
    key: 'outsideDidTap',
    value: function outsideDidTap(e) {
      var s = this;
      s.setState({ suggesting: false });
    }
  }, {
    key: 'handleKeyDown',
    value: function handleKeyDown(e) {
      var s = this;
      var props = s.props;

      switch (e.keyCode) {
        case 38:
          // UP
          s.moveCandidateIndex(-1);
          break;
        case 40:
          // DOWN
          s.moveCandidateIndex(+1);
          break;
        case 13:
          // Enter
          s.enterCandidate();
          if (props.onEnter) {
            props.onEnter();
          }
          break;
        default:
          s.setState({ suggesting: true });
          break;
      }
      if (props.onKeyDown) {
        props.onKeyDown(e);
      }
    }
  }, {
    key: 'moveCandidateIndex',
    value: function moveCandidateIndex(amount) {
      var s = this;
      var _s$state = s.state,
          candidates = _s$state.candidates,
          selectedCandidate = _s$state.selectedCandidate;

      if (!candidates) {
        return;
      }
      var index = candidates.indexOf(selectedCandidate) + amount;
      var over = index === -1 || index === candidates.length;
      if (over) {
        return;
      }
      s.setState({
        selectedCandidate: candidates[index] || null
      });
    }
  }, {
    key: 'updateCandidates',
    value: function updateCandidates() {
      var s = this;
      var props = s.props;
      var value = props.value;

      var candidates = (props.candidates || []).filter(function (candidate) {
        return !!candidate;
      }).map(function (candidate) {
        return String(candidate).trim();
      }).filter(function (candidate) {
        return !value || candidate.match(value);
      });

      var hit = candidates.length === 1 && candidates[0] === value;
      if (hit) {
        candidates = null;
      }
      s.setState({ candidates: candidates });
    }
  }, {
    key: 'enterCandidate',
    value: function enterCandidate() {
      var s = this;
      var props = s.props;
      var _s$state2 = s.state,
          candidates = _s$state2.candidates,
          selectedCandidate = _s$state2.selectedCandidate;

      var valid = candidates && !!~candidates.indexOf(selectedCandidate);
      if (valid) {
        var target = { value: selectedCandidate };
        if (props.onChange) {
          props.onChange({ target: target });
        }
        s.setState({ suggesting: false });
      }
    }

    // --------------------
    // Static methods
    // --------------------

  }], [{
    key: 'Text',
    value: function Text(_ref) {
      var id = _ref.id,
          name = _ref.name,
          value = _ref.value,
          placeholder = _ref.placeholder,
          autoComplete = _ref.autoComplete,
          className = _ref.className,
          autoFocus = _ref.autoFocus,
          multiline = _ref.multiline,
          handlers = _ref.handlers,
          rows = _ref.rows;

      if (multiline) {
        return _react2.default.createElement('textarea', (0, _extends3.default)({ autoFocus: autoFocus,
          id: id,
          name: name,
          rows: rows,
          placeholder: placeholder,
          className: (0, _classnames2.default)('ap-text ap-text-multiple', className),
          value: value
        }, handlers, {
          onFocus: null
        }));
      } else {
        return _react2.default.createElement('input', (0, _extends3.default)({ autoFocus: autoFocus,
          id: id,
          name: name,
          placeholder: placeholder,
          className: (0, _classnames2.default)('ap-text', className),
          value: value,
          autoComplete: autoComplete
        }, handlers, {
          type: 'text'
        }));
      }
    }
  }, {
    key: 'CandidateList',
    value: function CandidateList(_ref2) {
      var suggesting = _ref2.suggesting,
          candidates = _ref2.candidates,
          selectedCandidate = _ref2.selectedCandidate,
          multiline = _ref2.multiline,
          handlers = _ref2.handlers;

      if (!suggesting) {
        return null;
      }

      if (!candidates) {
        return null;
      }

      if (!candidates.length) {
        return null;
      }

      if (multiline) {
        console.warn('[ApText] Can not use candidates with multiline input.');
        return null;
      }

      return _react2.default.createElement(
        'ul',
        { className: 'ap-text-candidate-list' },
        candidates.map(function (candidate) {
          return _react2.default.createElement(
            'li',
            { key: candidate,
              className: (0, _classnames2.default)('ap-text-candidate-list-item', {
                'ap-text-candidate-list-item-selected': candidate === selectedCandidate
              }) },
            _react2.default.createElement(
              'a',
              (0, _extends3.default)({}, handlers, {
                'data-value': candidate }),
              candidate
            )
          );
        })
      );
    }
  }]);
  return ApText;
}(_react.Component);

(0, _assign2.default)(ApText, {
  // --------------------
  // Specs
  // --------------------

  propTypes: {
    /** Name of text input */
    name: _react.PropTypes.string,
    /** Value of text input */
    value: _react.PropTypes.string,
    /** Placeholder text */
    placeholder: _react.PropTypes.string,
    /** Number of rows */
    rows: _react.PropTypes.number,
    /** Selectable candidate text */
    candidates: _react.PropTypes.arrayOf(_react.PropTypes.string),
    /** Callback for entry key press */
    onEnter: _react.PropTypes.func
  },

  defaultProps: {
    name: '',
    value: '',
    placeholder: '',
    rows: 1,
    candidates: null
  }

});

exports.default = ApText;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImFwX3RleHQuanN4Il0sIm5hbWVzIjpbIkFwVGV4dCIsInByb3BzIiwicyIsInN0YXRlIiwic3VnZ2VzdGluZyIsImNhbmRpZGF0ZXMiLCJzZWxlY3RlZENhbmRpZGF0ZSIsIm1ldGhvZHNUb0JpbmQiLCJuYW1lIiwiYmluZCIsImhhbmRsZUNsaWNrRm9yT3V0c2lkZSIsImlkIiwicGxhY2Vob2xkZXIiLCJhdXRvQ29tcGxldGUiLCJhdXRvRm9jdXMiLCJjbGFzc05hbWUiLCJ2YWx1ZSIsInJvd3MiLCJoYXNWYWwiLCJtdWx0aWxpbmUiLCJ0ZXh0SGFuZGxlcnMiLCJvbkZvY3VzIiwiaGFuZGxlRm9jdXMiLCJvbktleVVwIiwiaGFuZGxlS2V5VXAiLCJvbkNoYW5nZSIsImhhbmRsZUNoYW5nZSIsIm9uQmx1ciIsImhhbmRsZUJsdXIiLCJvbktleURvd24iLCJoYW5kbGVLZXlEb3duIiwiY2FuZGlkYXRlSGFuZGxlcnMiLCJvbkNsaWNrIiwiaGFuZGxlQ2FuZGlkYXRlIiwiYm9keSIsImFkZEV2ZW50TGlzdGVuZXIiLCJyZW1vdmVFdmVudExpc3RlbmVyIiwiZSIsInRhcmdldCIsImRhdGFzZXQiLCJzZXRTdGF0ZSIsInVwZGF0ZUNhbmRpZGF0ZXMiLCJub2RlIiwiZmluZERPTU5vZGUiLCJjb250YWluZWQiLCJjb250YWlucyIsIm91dHNpZGVEaWRUYXAiLCJrZXlDb2RlIiwibW92ZUNhbmRpZGF0ZUluZGV4IiwiZW50ZXJDYW5kaWRhdGUiLCJvbkVudGVyIiwiYW1vdW50IiwiaW5kZXgiLCJpbmRleE9mIiwib3ZlciIsImxlbmd0aCIsImZpbHRlciIsImNhbmRpZGF0ZSIsIm1hcCIsIlN0cmluZyIsInRyaW0iLCJtYXRjaCIsImhpdCIsInZhbGlkIiwiaGFuZGxlcnMiLCJjb25zb2xlIiwid2FybiIsInByb3BUeXBlcyIsInN0cmluZyIsIm51bWJlciIsImFycmF5T2YiLCJmdW5jIiwiZGVmYXVsdFByb3BzIl0sIm1hcHBpbmdzIjoiQUFBQTs7Ozs7QUFLQTs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7QUFFQTs7OztBQUNBOzs7O0FBQ0E7Ozs7QUFDQTs7OztBQUVBO0lBQ01BLE07OztBQUNKO0FBQ0E7QUFDQTtBQUNBLGtCQUFhQyxLQUFiLEVBQW9CO0FBQUE7O0FBQUEsc0lBQ1pBLEtBRFk7O0FBRWxCLFFBQU1DLFNBQU47QUFDQUEsTUFBRUMsS0FBRixHQUFVO0FBQ1JDLGtCQUFZLEtBREo7QUFFUkMsa0JBQVksSUFGSjtBQUdSQyx5QkFBbUI7QUFIWCxLQUFWO0FBS0EsUUFBSUMsZ0JBQWdCLENBQ2xCLGFBRGtCLEVBRWxCLGFBRmtCLEVBR2xCLGNBSGtCLEVBSWxCLFlBSmtCLEVBS2xCLGVBTGtCLEVBTWxCLGlCQU5rQixDQUFwQjtBQVJrQjtBQUFBO0FBQUE7O0FBQUE7QUFnQmxCLHNEQUFpQkEsYUFBakIsNEdBQWdDO0FBQUEsWUFBdkJDLElBQXVCOztBQUM5Qk4sVUFBR00sSUFBSCxJQUFZTixFQUFHTSxJQUFILEVBQVVDLElBQVYsQ0FBZVAsQ0FBZixDQUFaO0FBQ0Q7QUFsQmlCO0FBQUE7QUFBQTtBQUFBO0FBQUE7QUFBQTtBQUFBO0FBQUE7QUFBQTtBQUFBO0FBQUE7QUFBQTtBQUFBO0FBQUE7O0FBbUJsQkEsTUFBRVEscUJBQUYsR0FBMEJSLEVBQUVRLHFCQUFGLENBQXdCRCxJQUF4QixDQUE2QlAsQ0FBN0IsQ0FBMUI7QUFuQmtCO0FBb0JuQjs7Ozs2QkFFUztBQUNSLFVBQU1BLElBQUksSUFBVjtBQURRLFVBRUZDLEtBRkUsR0FFZUQsQ0FGZixDQUVGQyxLQUZFO0FBQUEsVUFFS0YsS0FGTCxHQUVlQyxDQUZmLENBRUtELEtBRkw7QUFBQSxVQUlOVSxFQUpNLEdBWUpWLEtBWkksQ0FJTlUsRUFKTTtBQUFBLFVBS05ILElBTE0sR0FZSlAsS0FaSSxDQUtOTyxJQUxNO0FBQUEsVUFNTkksV0FOTSxHQVlKWCxLQVpJLENBTU5XLFdBTk07QUFBQSxVQU9OQyxZQVBNLEdBWUpaLEtBWkksQ0FPTlksWUFQTTtBQUFBLFVBUU5DLFNBUk0sR0FZSmIsS0FaSSxDQVFOYSxTQVJNO0FBQUEsVUFTTkMsU0FUTSxHQVlKZCxLQVpJLENBU05jLFNBVE07QUFBQSxVQVVOQyxLQVZNLEdBWUpmLEtBWkksQ0FVTmUsS0FWTTtBQUFBLFVBV05DLElBWE0sR0FZSmhCLEtBWkksQ0FXTmdCLElBWE07O0FBYVIsVUFBSUMsU0FBUyxDQUFDLENBQUNGLEtBQWY7O0FBRUEsVUFBSUcsWUFBWUYsUUFBU0EsT0FBTyxDQUFoQzs7QUFmUSxVQWtCTlosVUFsQk0sR0FxQkpGLEtBckJJLENBa0JORSxVQWxCTTtBQUFBLFVBbUJOQyxpQkFuQk0sR0FxQkpILEtBckJJLENBbUJORyxpQkFuQk07QUFBQSxVQW9CTkYsVUFwQk0sR0FxQkpELEtBckJJLENBb0JOQyxVQXBCTTs7O0FBdUJSLFVBQUlnQixlQUFlO0FBQ2pCQyxpQkFBU25CLEVBQUVvQixXQURNO0FBRWpCQyxpQkFBU3JCLEVBQUVzQixXQUZNO0FBR2pCQyxrQkFBVXZCLEVBQUV3QixZQUhLO0FBSWpCQyxnQkFBUXpCLEVBQUUwQixVQUpPO0FBS2pCQyxtQkFBVzNCLEVBQUU0QjtBQUxJLE9BQW5CO0FBT0EsVUFBSUMsb0JBQW9CO0FBQ3RCQyxpQkFBUzlCLEVBQUUrQjtBQURXLE9BQXhCOztBQUlBLGFBQ0U7QUFBQTtBQUFBLFVBQU0sV0FBWSwwQkFBVyxjQUFYLEVBQTJCLEVBQUUsc0JBQXNCLENBQUNmLE1BQXpCLEVBQTNCLENBQWxCO0FBQ0Usc0NBQUMsTUFBRCxDQUFRLElBQVIseUJBQWtCLEVBQUVQLE1BQUYsRUFBTUgsVUFBTixFQUFZUSxZQUFaLEVBQW1CSix3QkFBbkIsRUFBZ0NHLG9CQUFoQyxFQUEyQ0Qsb0JBQTNDLEVBQXNERCwwQkFBdEQsRUFBb0VNLG9CQUFwRSxFQUErRUYsVUFBL0UsRUFBbEI7QUFDYSxvQkFBV0c7QUFEeEIsV0FERjtBQUlFLHNDQUFDLE1BQUQsQ0FBUSxhQUFSLHlCQUEyQixFQUFFaEIsc0JBQUYsRUFBY0Msc0JBQWQsRUFBMEJDLG9DQUExQixFQUE2Q2Esb0JBQTdDLEVBQTNCO0FBQ3NCLG9CQUFXWTtBQURqQztBQUpGLE9BREY7QUFVRDs7O3dDQUVvQjtBQUNuQixVQUFNN0IsSUFBSSxJQUFWO0FBQ0EsVUFBSWdDLE9BQU8sa0JBQUksZUFBSixDQUFYO0FBQ0FBLFdBQUtDLGdCQUFMLENBQXNCLE9BQXRCLEVBQStCakMsRUFBRVEscUJBQWpDO0FBQ0Q7OzsyQ0FFdUI7QUFDdEIsVUFBTVIsSUFBSSxJQUFWO0FBQ0EsVUFBSWdDLE9BQU8sa0JBQUksZUFBSixDQUFYO0FBQ0FBLFdBQUtFLG1CQUFMLENBQXlCLE9BQXpCLEVBQWtDbEMsRUFBRVEscUJBQXBDO0FBRUQ7O0FBRUQ7QUFDQTtBQUNBOzs7O29DQUVpQjJCLEMsRUFBRztBQUNsQixVQUFNbkMsSUFBSSxJQUFWO0FBRGtCLFVBRVpELEtBRlksR0FFRkMsQ0FGRSxDQUVaRCxLQUZZOztBQUdsQm9DLFFBQUVDLE1BQUYsQ0FBU3RCLEtBQVQsR0FBaUJxQixFQUFFQyxNQUFGLENBQVN0QixLQUFULElBQWtCcUIsRUFBRUMsTUFBRixDQUFTQyxPQUFULENBQWlCdkIsS0FBcEQ7QUFDQWQsUUFBRXNDLFFBQUYsQ0FBVyxFQUFFcEMsWUFBWSxLQUFkLEVBQVg7QUFDQSxVQUFJSCxNQUFNd0IsUUFBVixFQUFvQjtBQUNsQnhCLGNBQU13QixRQUFOLENBQWVZLENBQWY7QUFDRDtBQUNGOzs7Z0NBRVlBLEMsRUFBRztBQUNkLFVBQU1uQyxJQUFJLElBQVY7QUFEYyxVQUVSRCxLQUZRLEdBRUVDLENBRkYsQ0FFUkQsS0FGUTs7QUFHZEMsUUFBRXNDLFFBQUYsQ0FBVyxFQUFFcEMsWUFBWSxJQUFkLEVBQVg7QUFDQUYsUUFBRXVDLGdCQUFGO0FBQ0EsVUFBSXhDLE1BQU1vQixPQUFWLEVBQW1CO0FBQ2pCcEIsY0FBTW9CLE9BQU4sQ0FBY2dCLENBQWQ7QUFDRDtBQUNGOzs7aUNBRWFBLEMsRUFBRztBQUNmLFVBQU1uQyxJQUFJLElBQVY7QUFEZSxVQUVURCxLQUZTLEdBRUNDLENBRkQsQ0FFVEQsS0FGUzs7QUFHZkMsUUFBRXNDLFFBQUYsQ0FBVyxFQUFFcEMsWUFBWSxJQUFkLEVBQVg7QUFDQSxVQUFJSCxNQUFNd0IsUUFBVixFQUFvQjtBQUNsQnhCLGNBQU13QixRQUFOLENBQWVZLENBQWY7QUFDRDtBQUNGOzs7K0JBRVdBLEMsRUFBRztBQUNiLFVBQU1uQyxJQUFJLElBQVY7QUFEYSxVQUVQRCxLQUZPLEdBRUdDLENBRkgsQ0FFUEQsS0FGTzs7O0FBSWIsVUFBSUEsTUFBTTBCLE1BQVYsRUFBa0I7QUFDaEIxQixjQUFNMEIsTUFBTixDQUFhVSxDQUFiO0FBQ0Q7QUFDRjs7O2dDQUVZQSxDLEVBQUc7QUFDZCxVQUFNbkMsSUFBSSxJQUFWO0FBRGMsVUFFUkQsS0FGUSxHQUVFQyxDQUZGLENBRVJELEtBRlE7O0FBR2RDLFFBQUV1QyxnQkFBRjtBQUNBLFVBQUl4QyxNQUFNc0IsT0FBVixFQUFtQjtBQUNqQnRCLGNBQU1zQixPQUFOLENBQWNjLENBQWQ7QUFDRDtBQUNGOzs7MENBRXNCQSxDLEVBQUc7QUFDeEIsVUFBTW5DLElBQUksSUFBVjtBQUNBLFVBQUl3QyxPQUFPLG1CQUFTQyxXQUFULENBQXFCekMsQ0FBckIsQ0FBWDtBQUNBLFVBQUksQ0FBQ3dDLElBQUwsRUFBVztBQUNUO0FBQ0Q7QUFDRCxVQUFJRSxZQUFZRixLQUFLRyxRQUFMLENBQWNSLEVBQUVDLE1BQWhCLENBQWhCO0FBQ0EsVUFBSSxDQUFDTSxTQUFMLEVBQWdCO0FBQ2QxQyxVQUFFNEMsYUFBRixDQUFnQlQsQ0FBaEI7QUFDRDtBQUNGOzs7a0NBRWNBLEMsRUFBRztBQUNoQixVQUFNbkMsSUFBSSxJQUFWO0FBQ0FBLFFBQUVzQyxRQUFGLENBQVcsRUFBRXBDLFlBQVksS0FBZCxFQUFYO0FBQ0Q7OztrQ0FFY2lDLEMsRUFBRztBQUNoQixVQUFNbkMsSUFBSSxJQUFWO0FBRGdCLFVBRVZELEtBRlUsR0FFQUMsQ0FGQSxDQUVWRCxLQUZVOztBQUdoQixjQUFRb0MsRUFBRVUsT0FBVjtBQUNFLGFBQUssRUFBTDtBQUFTO0FBQ1A3QyxZQUFFOEMsa0JBQUYsQ0FBcUIsQ0FBQyxDQUF0QjtBQUNBO0FBQ0YsYUFBSyxFQUFMO0FBQVM7QUFDUDlDLFlBQUU4QyxrQkFBRixDQUFxQixDQUFDLENBQXRCO0FBQ0E7QUFDRixhQUFLLEVBQUw7QUFBUztBQUNQOUMsWUFBRStDLGNBQUY7QUFDQSxjQUFJaEQsTUFBTWlELE9BQVYsRUFBbUI7QUFDakJqRCxrQkFBTWlELE9BQU47QUFDRDtBQUNEO0FBQ0Y7QUFDRWhELFlBQUVzQyxRQUFGLENBQVcsRUFBRXBDLFlBQVksSUFBZCxFQUFYO0FBQ0E7QUFmSjtBQWlCQSxVQUFJSCxNQUFNNEIsU0FBVixFQUFxQjtBQUNuQjVCLGNBQU00QixTQUFOLENBQWdCUSxDQUFoQjtBQUNEO0FBQ0Y7Ozt1Q0FFbUJjLE0sRUFBUTtBQUMxQixVQUFNakQsSUFBSSxJQUFWO0FBRDBCLHFCQUVjQSxFQUFFQyxLQUZoQjtBQUFBLFVBRXBCRSxVQUZvQixZQUVwQkEsVUFGb0I7QUFBQSxVQUVSQyxpQkFGUSxZQUVSQSxpQkFGUTs7QUFHMUIsVUFBSSxDQUFDRCxVQUFMLEVBQWlCO0FBQ2Y7QUFDRDtBQUNELFVBQUkrQyxRQUFRL0MsV0FBV2dELE9BQVgsQ0FBbUIvQyxpQkFBbkIsSUFBd0M2QyxNQUFwRDtBQUNBLFVBQUlHLE9BQVFGLFVBQVUsQ0FBQyxDQUFaLElBQW1CQSxVQUFVL0MsV0FBV2tELE1BQW5EO0FBQ0EsVUFBSUQsSUFBSixFQUFVO0FBQ1I7QUFDRDtBQUNEcEQsUUFBRXNDLFFBQUYsQ0FBVztBQUNUbEMsMkJBQW1CRCxXQUFZK0MsS0FBWixLQUF1QjtBQURqQyxPQUFYO0FBR0Q7Ozt1Q0FFbUI7QUFDbEIsVUFBTWxELElBQUksSUFBVjtBQURrQixVQUVaRCxLQUZZLEdBRUZDLENBRkUsQ0FFWkQsS0FGWTtBQUFBLFVBR1plLEtBSFksR0FHRmYsS0FIRSxDQUdaZSxLQUhZOztBQUlsQixVQUFJWCxhQUFhLENBQUNKLE1BQU1JLFVBQU4sSUFBb0IsRUFBckIsRUFDZG1ELE1BRGMsQ0FDUCxVQUFDQyxTQUFEO0FBQUEsZUFBZSxDQUFDLENBQUNBLFNBQWpCO0FBQUEsT0FETyxFQUVkQyxHQUZjLENBRVYsVUFBQ0QsU0FBRDtBQUFBLGVBQWVFLE9BQU9GLFNBQVAsRUFBa0JHLElBQWxCLEVBQWY7QUFBQSxPQUZVLEVBR2RKLE1BSGMsQ0FHUCxVQUFDQyxTQUFEO0FBQUEsZUFBZSxDQUFDekMsS0FBRCxJQUFVeUMsVUFBVUksS0FBVixDQUFnQjdDLEtBQWhCLENBQXpCO0FBQUEsT0FITyxDQUFqQjs7QUFLQSxVQUFJOEMsTUFBT3pELFdBQVdrRCxNQUFYLEtBQXNCLENBQXZCLElBQThCbEQsV0FBWSxDQUFaLE1BQW9CVyxLQUE1RDtBQUNBLFVBQUk4QyxHQUFKLEVBQVM7QUFDUHpELHFCQUFhLElBQWI7QUFDRDtBQUNESCxRQUFFc0MsUUFBRixDQUFXLEVBQUVuQyxzQkFBRixFQUFYO0FBQ0Q7OztxQ0FFaUI7QUFDaEIsVUFBTUgsSUFBSSxJQUFWO0FBRGdCLFVBRVZELEtBRlUsR0FFQUMsQ0FGQSxDQUVWRCxLQUZVO0FBQUEsc0JBR3dCQyxFQUFFQyxLQUgxQjtBQUFBLFVBR1ZFLFVBSFUsYUFHVkEsVUFIVTtBQUFBLFVBR0VDLGlCQUhGLGFBR0VBLGlCQUhGOztBQUloQixVQUFJeUQsUUFBUTFELGNBQWMsQ0FBQyxDQUFDLENBQUNBLFdBQVdnRCxPQUFYLENBQW1CL0MsaUJBQW5CLENBQTdCO0FBQ0EsVUFBSXlELEtBQUosRUFBVztBQUNULFlBQUl6QixTQUFTLEVBQUV0QixPQUFPVixpQkFBVCxFQUFiO0FBQ0EsWUFBSUwsTUFBTXdCLFFBQVYsRUFBb0I7QUFDbEJ4QixnQkFBTXdCLFFBQU4sQ0FBZSxFQUFFYSxjQUFGLEVBQWY7QUFDRDtBQUNEcEMsVUFBRXNDLFFBQUYsQ0FBVyxFQUFFcEMsWUFBWSxLQUFkLEVBQVg7QUFDRDtBQUNGOztBQUVEO0FBQ0E7QUFDQTs7OzsrQkFZZ0I7QUFBQSxVQVZETyxFQVVDLFFBVkRBLEVBVUM7QUFBQSxVQVRESCxJQVNDLFFBVERBLElBU0M7QUFBQSxVQVJEUSxLQVFDLFFBUkRBLEtBUUM7QUFBQSxVQVBESixXQU9DLFFBUERBLFdBT0M7QUFBQSxVQU5EQyxZQU1DLFFBTkRBLFlBTUM7QUFBQSxVQUxERSxTQUtDLFFBTERBLFNBS0M7QUFBQSxVQUpERCxTQUlDLFFBSkRBLFNBSUM7QUFBQSxVQUhESyxTQUdDLFFBSERBLFNBR0M7QUFBQSxVQUZENkMsUUFFQyxRQUZEQSxRQUVDO0FBQUEsVUFERC9DLElBQ0MsUUFEREEsSUFDQzs7QUFDZCxVQUFJRSxTQUFKLEVBQWU7QUFDYixlQUNFLG1FQUFVLFdBQVlMLFNBQXRCO0FBQ1UsY0FBS0gsRUFEZjtBQUVVLGdCQUFPSCxJQUZqQjtBQUdVLGdCQUFPUyxJQUhqQjtBQUlVLHVCQUFjTCxXQUp4QjtBQUtVLHFCQUFZLDBCQUFXLDBCQUFYLEVBQXVDRyxTQUF2QyxDQUx0QjtBQU1VLGlCQUFRQztBQU5sQixXQU9lZ0QsUUFQZjtBQVFVLG1CQUFVO0FBUnBCLFdBREY7QUFhRCxPQWRELE1BY087QUFDTCxlQUNFLGdFQUFPLFdBQVlsRCxTQUFuQjtBQUNPLGNBQUtILEVBRFo7QUFFTyxnQkFBT0gsSUFGZDtBQUdPLHVCQUFjSSxXQUhyQjtBQUlPLHFCQUFZLDBCQUFXLFNBQVgsRUFBc0JHLFNBQXRCLENBSm5CO0FBS08saUJBQVFDLEtBTGY7QUFNTyx3QkFBZUg7QUFOdEIsV0FPWW1ELFFBUFo7QUFRTyxnQkFBSztBQVJaLFdBREY7QUFZRDtBQUNGOzs7eUNBRXlGO0FBQUEsVUFBbEU1RCxVQUFrRSxTQUFsRUEsVUFBa0U7QUFBQSxVQUF0REMsVUFBc0QsU0FBdERBLFVBQXNEO0FBQUEsVUFBMUNDLGlCQUEwQyxTQUExQ0EsaUJBQTBDO0FBQUEsVUFBdkJhLFNBQXVCLFNBQXZCQSxTQUF1QjtBQUFBLFVBQVo2QyxRQUFZLFNBQVpBLFFBQVk7O0FBQ3hGLFVBQUksQ0FBQzVELFVBQUwsRUFBaUI7QUFDZixlQUFPLElBQVA7QUFDRDs7QUFFRCxVQUFJLENBQUNDLFVBQUwsRUFBaUI7QUFDZixlQUFPLElBQVA7QUFDRDs7QUFFRCxVQUFJLENBQUNBLFdBQVdrRCxNQUFoQixFQUF3QjtBQUN0QixlQUFPLElBQVA7QUFDRDs7QUFFRCxVQUFJcEMsU0FBSixFQUFlO0FBQ2I4QyxnQkFBUUMsSUFBUixDQUFhLHVEQUFiO0FBQ0EsZUFBTyxJQUFQO0FBQ0Q7O0FBRUQsYUFDRTtBQUFBO0FBQUEsVUFBSSxXQUFVLHdCQUFkO0FBRUk3RCxtQkFBV3FELEdBQVgsQ0FBZSxVQUFDRCxTQUFEO0FBQUEsaUJBQ2I7QUFBQTtBQUFBLGNBQUksS0FBTUEsU0FBVjtBQUNJLHlCQUFZLDBCQUFXLDZCQUFYLEVBQTBDO0FBQ3BELHdEQUF3Q0EsY0FBY25EO0FBREYsZUFBMUMsQ0FEaEI7QUFJRTtBQUFBO0FBQUEseUNBQVEwRCxRQUFSO0FBQ0csOEJBQWFQLFNBRGhCO0FBQzhCQTtBQUQ5QjtBQUpGLFdBRGE7QUFBQSxTQUFmO0FBRkosT0FERjtBQWVEOzs7OztBQUdILHNCQUFjekQsTUFBZCxFQUFzQjtBQUNwQjtBQUNBO0FBQ0E7O0FBRUFtRSxhQUFXO0FBQ1Q7QUFDQTNELFVBQU0saUJBQU00RCxNQUZIO0FBR1Q7QUFDQXBELFdBQU8saUJBQU1vRCxNQUpKO0FBS1Q7QUFDQXhELGlCQUFhLGlCQUFNd0QsTUFOVjtBQU9UO0FBQ0FuRCxVQUFNLGlCQUFNb0QsTUFSSDtBQVNUO0FBQ0FoRSxnQkFBWSxpQkFBTWlFLE9BQU4sQ0FBYyxpQkFBTUYsTUFBcEIsQ0FWSDtBQVdUO0FBQ0FsQixhQUFTLGlCQUFNcUI7QUFaTixHQUxTOztBQW9CcEJDLGdCQUFjO0FBQ1poRSxVQUFNLEVBRE07QUFFWlEsV0FBTyxFQUZLO0FBR1pKLGlCQUFhLEVBSEQ7QUFJWkssVUFBTSxDQUpNO0FBS1paLGdCQUFZO0FBTEE7O0FBcEJNLENBQXRCOztrQkE4QmVMLE0iLCJmaWxlIjoiYXBfdGV4dC5qc3giLCJzb3VyY2VSb290IjoibGliIiwic291cmNlc0NvbnRlbnQiOlsiLyoqXG4gKiBhcGVtYW4gcmVhY3QgcGFja2FnZSB0ZXh0IGNvbXBvbmVudC5cbiAqIEBjbGFzcyBBcFRleHRcbiAqL1xuXG4ndXNlIHN0cmljdCdcblxuaW1wb3J0IFJlYWN0LCB7IENvbXBvbmVudCwgUHJvcFR5cGVzIGFzIHR5cGVzIH0gZnJvbSAncmVhY3QnXG5pbXBvcnQgUmVhY3RET00gZnJvbSAncmVhY3QtZG9tJ1xuaW1wb3J0IGNsYXNzbmFtZXMgZnJvbSAnY2xhc3NuYW1lcydcbmltcG9ydCB7IGdldCB9IGZyb20gJ2J3aW5kb3cnXG5cbi8qKiBAbGVuZHMgQXBUZXh0ICovXG5jbGFzcyBBcFRleHQgZXh0ZW5kcyBDb21wb25lbnQge1xuICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLVxuICAvLyBTcGVjc1xuICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLVxuICBjb25zdHJ1Y3RvciAocHJvcHMpIHtcbiAgICBzdXBlcihwcm9wcylcbiAgICBjb25zdCBzID0gdGhpc1xuICAgIHMuc3RhdGUgPSB7XG4gICAgICBzdWdnZXN0aW5nOiBmYWxzZSxcbiAgICAgIGNhbmRpZGF0ZXM6IG51bGwsXG4gICAgICBzZWxlY3RlZENhbmRpZGF0ZTogbnVsbFxuICAgIH1cbiAgICBsZXQgbWV0aG9kc1RvQmluZCA9IFtcbiAgICAgICdoYW5kbGVGb2N1cycsXG4gICAgICAnaGFuZGxlS2V5VXAnLFxuICAgICAgJ2hhbmRsZUNoYW5nZScsXG4gICAgICAnaGFuZGxlQmx1cicsXG4gICAgICAnaGFuZGxlS2V5RG93bicsXG4gICAgICAnaGFuZGxlQ2FuZGlkYXRlJ1xuICAgIF1cbiAgICBmb3IgKGxldCBuYW1lIG9mIG1ldGhvZHNUb0JpbmQpIHtcbiAgICAgIHNbIG5hbWUgXSA9IHNbIG5hbWUgXS5iaW5kKHMpXG4gICAgfVxuICAgIHMuaGFuZGxlQ2xpY2tGb3JPdXRzaWRlID0gcy5oYW5kbGVDbGlja0Zvck91dHNpZGUuYmluZChzKVxuICB9XG5cbiAgcmVuZGVyICgpIHtcbiAgICBjb25zdCBzID0gdGhpc1xuICAgIGxldCB7IHN0YXRlLCBwcm9wcyB9ID0gc1xuICAgIGxldCB7XG4gICAgICBpZCxcbiAgICAgIG5hbWUsXG4gICAgICBwbGFjZWhvbGRlcixcbiAgICAgIGF1dG9Db21wbGV0ZSxcbiAgICAgIGF1dG9Gb2N1cyxcbiAgICAgIGNsYXNzTmFtZSxcbiAgICAgIHZhbHVlLFxuICAgICAgcm93c1xuICAgIH0gPSBwcm9wc1xuICAgIGxldCBoYXNWYWwgPSAhIXZhbHVlXG5cbiAgICBsZXQgbXVsdGlsaW5lID0gcm93cyAmJiAocm93cyA+IDEpXG5cbiAgICBsZXQge1xuICAgICAgY2FuZGlkYXRlcyxcbiAgICAgIHNlbGVjdGVkQ2FuZGlkYXRlLFxuICAgICAgc3VnZ2VzdGluZ1xuICAgIH0gPSBzdGF0ZVxuXG4gICAgbGV0IHRleHRIYW5kbGVycyA9IHtcbiAgICAgIG9uRm9jdXM6IHMuaGFuZGxlRm9jdXMsXG4gICAgICBvbktleVVwOiBzLmhhbmRsZUtleVVwLFxuICAgICAgb25DaGFuZ2U6IHMuaGFuZGxlQ2hhbmdlLFxuICAgICAgb25CbHVyOiBzLmhhbmRsZUJsdXIsXG4gICAgICBvbktleURvd246IHMuaGFuZGxlS2V5RG93blxuICAgIH1cbiAgICBsZXQgY2FuZGlkYXRlSGFuZGxlcnMgPSB7XG4gICAgICBvbkNsaWNrOiBzLmhhbmRsZUNhbmRpZGF0ZVxuICAgIH1cblxuICAgIHJldHVybiAoXG4gICAgICA8c3BhbiBjbGFzc05hbWU9eyBjbGFzc25hbWVzKCdhcC10ZXh0LXdyYXAnLCB7ICdhcC10ZXh0LXdyYXAtZW1wdHknOiAhaGFzVmFsIH0pIH0+XG4gICAgICAgIDxBcFRleHQuVGV4dCB7IC4uLnsgaWQsIG5hbWUsIHZhbHVlLCBwbGFjZWhvbGRlciwgY2xhc3NOYW1lLCBhdXRvRm9jdXMsIGF1dG9Db21wbGV0ZSwgbXVsdGlsaW5lLCByb3dzIH0gfVxuICAgICAgICAgICAgICAgICAgICAgaGFuZGxlcnM9eyB0ZXh0SGFuZGxlcnMgfVxuICAgICAgICAvPlxuICAgICAgICA8QXBUZXh0LkNhbmRpZGF0ZUxpc3QgeyAuLi57IHN1Z2dlc3RpbmcsIGNhbmRpZGF0ZXMsIHNlbGVjdGVkQ2FuZGlkYXRlLCBtdWx0aWxpbmUgfSB9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICBoYW5kbGVycz17IGNhbmRpZGF0ZUhhbmRsZXJzIH1cbiAgICAgICAgLz5cbiAgICAgIDwvc3Bhbj5cbiAgICApXG4gIH1cblxuICBjb21wb25lbnREaWRNb3VudCAoKSB7XG4gICAgY29uc3QgcyA9IHRoaXNcbiAgICBsZXQgYm9keSA9IGdldCgnZG9jdW1lbnQuYm9keScpXG4gICAgYm9keS5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsIHMuaGFuZGxlQ2xpY2tGb3JPdXRzaWRlKVxuICB9XG5cbiAgY29tcG9uZW50V2lsbFVubW91bnQgKCkge1xuICAgIGNvbnN0IHMgPSB0aGlzXG4gICAgbGV0IGJvZHkgPSBnZXQoJ2RvY3VtZW50LmJvZHknKVxuICAgIGJvZHkucmVtb3ZlRXZlbnRMaXN0ZW5lcignY2xpY2snLCBzLmhhbmRsZUNsaWNrRm9yT3V0c2lkZSlcblxuICB9XG5cbiAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS1cbiAgLy8gQ3VzdG9tXG4gIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tXG5cbiAgaGFuZGxlQ2FuZGlkYXRlIChlKSB7XG4gICAgY29uc3QgcyA9IHRoaXNcbiAgICBsZXQgeyBwcm9wcyB9ID0gc1xuICAgIGUudGFyZ2V0LnZhbHVlID0gZS50YXJnZXQudmFsdWUgfHwgZS50YXJnZXQuZGF0YXNldC52YWx1ZVxuICAgIHMuc2V0U3RhdGUoeyBzdWdnZXN0aW5nOiBmYWxzZSB9KVxuICAgIGlmIChwcm9wcy5vbkNoYW5nZSkge1xuICAgICAgcHJvcHMub25DaGFuZ2UoZSlcbiAgICB9XG4gIH1cblxuICBoYW5kbGVGb2N1cyAoZSkge1xuICAgIGNvbnN0IHMgPSB0aGlzXG4gICAgbGV0IHsgcHJvcHMgfSA9IHNcbiAgICBzLnNldFN0YXRlKHsgc3VnZ2VzdGluZzogdHJ1ZSB9KVxuICAgIHMudXBkYXRlQ2FuZGlkYXRlcygpXG4gICAgaWYgKHByb3BzLm9uRm9jdXMpIHtcbiAgICAgIHByb3BzLm9uRm9jdXMoZSlcbiAgICB9XG4gIH1cblxuICBoYW5kbGVDaGFuZ2UgKGUpIHtcbiAgICBjb25zdCBzID0gdGhpc1xuICAgIGxldCB7IHByb3BzIH0gPSBzXG4gICAgcy5zZXRTdGF0ZSh7IHN1Z2dlc3Rpbmc6IHRydWUgfSlcbiAgICBpZiAocHJvcHMub25DaGFuZ2UpIHtcbiAgICAgIHByb3BzLm9uQ2hhbmdlKGUpXG4gICAgfVxuICB9XG5cbiAgaGFuZGxlQmx1ciAoZSkge1xuICAgIGNvbnN0IHMgPSB0aGlzXG4gICAgbGV0IHsgcHJvcHMgfSA9IHNcblxuICAgIGlmIChwcm9wcy5vbkJsdXIpIHtcbiAgICAgIHByb3BzLm9uQmx1cihlKVxuICAgIH1cbiAgfVxuXG4gIGhhbmRsZUtleVVwIChlKSB7XG4gICAgY29uc3QgcyA9IHRoaXNcbiAgICBsZXQgeyBwcm9wcyB9ID0gc1xuICAgIHMudXBkYXRlQ2FuZGlkYXRlcygpXG4gICAgaWYgKHByb3BzLm9uS2V5VXApIHtcbiAgICAgIHByb3BzLm9uS2V5VXAoZSlcbiAgICB9XG4gIH1cblxuICBoYW5kbGVDbGlja0Zvck91dHNpZGUgKGUpIHtcbiAgICBjb25zdCBzID0gdGhpc1xuICAgIGxldCBub2RlID0gUmVhY3RET00uZmluZERPTU5vZGUocylcbiAgICBpZiAoIW5vZGUpIHtcbiAgICAgIHJldHVyblxuICAgIH1cbiAgICBsZXQgY29udGFpbmVkID0gbm9kZS5jb250YWlucyhlLnRhcmdldClcbiAgICBpZiAoIWNvbnRhaW5lZCkge1xuICAgICAgcy5vdXRzaWRlRGlkVGFwKGUpXG4gICAgfVxuICB9XG5cbiAgb3V0c2lkZURpZFRhcCAoZSkge1xuICAgIGNvbnN0IHMgPSB0aGlzXG4gICAgcy5zZXRTdGF0ZSh7IHN1Z2dlc3Rpbmc6IGZhbHNlIH0pXG4gIH1cblxuICBoYW5kbGVLZXlEb3duIChlKSB7XG4gICAgY29uc3QgcyA9IHRoaXNcbiAgICBsZXQgeyBwcm9wcyB9ID0gc1xuICAgIHN3aXRjaCAoZS5rZXlDb2RlKSB7XG4gICAgICBjYXNlIDM4OiAvLyBVUFxuICAgICAgICBzLm1vdmVDYW5kaWRhdGVJbmRleCgtMSlcbiAgICAgICAgYnJlYWtcbiAgICAgIGNhc2UgNDA6IC8vIERPV05cbiAgICAgICAgcy5tb3ZlQ2FuZGlkYXRlSW5kZXgoKzEpXG4gICAgICAgIGJyZWFrXG4gICAgICBjYXNlIDEzOiAvLyBFbnRlclxuICAgICAgICBzLmVudGVyQ2FuZGlkYXRlKClcbiAgICAgICAgaWYgKHByb3BzLm9uRW50ZXIpIHtcbiAgICAgICAgICBwcm9wcy5vbkVudGVyKClcbiAgICAgICAgfVxuICAgICAgICBicmVha1xuICAgICAgZGVmYXVsdDpcbiAgICAgICAgcy5zZXRTdGF0ZSh7IHN1Z2dlc3Rpbmc6IHRydWUgfSlcbiAgICAgICAgYnJlYWtcbiAgICB9XG4gICAgaWYgKHByb3BzLm9uS2V5RG93bikge1xuICAgICAgcHJvcHMub25LZXlEb3duKGUpXG4gICAgfVxuICB9XG5cbiAgbW92ZUNhbmRpZGF0ZUluZGV4IChhbW91bnQpIHtcbiAgICBjb25zdCBzID0gdGhpc1xuICAgIGxldCB7IGNhbmRpZGF0ZXMsIHNlbGVjdGVkQ2FuZGlkYXRlIH0gPSBzLnN0YXRlXG4gICAgaWYgKCFjYW5kaWRhdGVzKSB7XG4gICAgICByZXR1cm5cbiAgICB9XG4gICAgbGV0IGluZGV4ID0gY2FuZGlkYXRlcy5pbmRleE9mKHNlbGVjdGVkQ2FuZGlkYXRlKSArIGFtb3VudFxuICAgIGxldCBvdmVyID0gKGluZGV4ID09PSAtMSkgfHwgKGluZGV4ID09PSBjYW5kaWRhdGVzLmxlbmd0aClcbiAgICBpZiAob3Zlcikge1xuICAgICAgcmV0dXJuXG4gICAgfVxuICAgIHMuc2V0U3RhdGUoe1xuICAgICAgc2VsZWN0ZWRDYW5kaWRhdGU6IGNhbmRpZGF0ZXNbIGluZGV4IF0gfHwgbnVsbFxuICAgIH0pXG4gIH1cblxuICB1cGRhdGVDYW5kaWRhdGVzICgpIHtcbiAgICBjb25zdCBzID0gdGhpc1xuICAgIGxldCB7IHByb3BzIH0gPSBzXG4gICAgbGV0IHsgdmFsdWUgfSA9IHByb3BzXG4gICAgbGV0IGNhbmRpZGF0ZXMgPSAocHJvcHMuY2FuZGlkYXRlcyB8fCBbXSlcbiAgICAgIC5maWx0ZXIoKGNhbmRpZGF0ZSkgPT4gISFjYW5kaWRhdGUpXG4gICAgICAubWFwKChjYW5kaWRhdGUpID0+IFN0cmluZyhjYW5kaWRhdGUpLnRyaW0oKSlcbiAgICAgIC5maWx0ZXIoKGNhbmRpZGF0ZSkgPT4gIXZhbHVlIHx8IGNhbmRpZGF0ZS5tYXRjaCh2YWx1ZSkpXG5cbiAgICBsZXQgaGl0ID0gKGNhbmRpZGF0ZXMubGVuZ3RoID09PSAxKSAmJiAoY2FuZGlkYXRlc1sgMCBdID09PSB2YWx1ZSlcbiAgICBpZiAoaGl0KSB7XG4gICAgICBjYW5kaWRhdGVzID0gbnVsbFxuICAgIH1cbiAgICBzLnNldFN0YXRlKHsgY2FuZGlkYXRlcyB9KVxuICB9XG5cbiAgZW50ZXJDYW5kaWRhdGUgKCkge1xuICAgIGNvbnN0IHMgPSB0aGlzXG4gICAgbGV0IHsgcHJvcHMgfSA9IHNcbiAgICBsZXQgeyBjYW5kaWRhdGVzLCBzZWxlY3RlZENhbmRpZGF0ZSB9ID0gcy5zdGF0ZVxuICAgIGxldCB2YWxpZCA9IGNhbmRpZGF0ZXMgJiYgISF+Y2FuZGlkYXRlcy5pbmRleE9mKHNlbGVjdGVkQ2FuZGlkYXRlKVxuICAgIGlmICh2YWxpZCkge1xuICAgICAgbGV0IHRhcmdldCA9IHsgdmFsdWU6IHNlbGVjdGVkQ2FuZGlkYXRlIH1cbiAgICAgIGlmIChwcm9wcy5vbkNoYW5nZSkge1xuICAgICAgICBwcm9wcy5vbkNoYW5nZSh7IHRhcmdldCB9KVxuICAgICAgfVxuICAgICAgcy5zZXRTdGF0ZSh7IHN1Z2dlc3Rpbmc6IGZhbHNlIH0pXG4gICAgfVxuICB9XG5cbiAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS1cbiAgLy8gU3RhdGljIG1ldGhvZHNcbiAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS1cbiAgc3RhdGljIFRleHQgKHtcbiAgICAgICAgICAgICAgICAgaWQsXG4gICAgICAgICAgICAgICAgIG5hbWUsXG4gICAgICAgICAgICAgICAgIHZhbHVlLFxuICAgICAgICAgICAgICAgICBwbGFjZWhvbGRlcixcbiAgICAgICAgICAgICAgICAgYXV0b0NvbXBsZXRlLFxuICAgICAgICAgICAgICAgICBjbGFzc05hbWUsXG4gICAgICAgICAgICAgICAgIGF1dG9Gb2N1cyxcbiAgICAgICAgICAgICAgICAgbXVsdGlsaW5lLFxuICAgICAgICAgICAgICAgICBoYW5kbGVycyxcbiAgICAgICAgICAgICAgICAgcm93c1xuICAgICAgICAgICAgICAgfSkge1xuICAgIGlmIChtdWx0aWxpbmUpIHtcbiAgICAgIHJldHVybiAoXG4gICAgICAgIDx0ZXh0YXJlYSBhdXRvRm9jdXM9eyBhdXRvRm9jdXMgfVxuICAgICAgICAgICAgICAgICAgaWQ9eyBpZCB9XG4gICAgICAgICAgICAgICAgICBuYW1lPXsgbmFtZSB9XG4gICAgICAgICAgICAgICAgICByb3dzPXsgcm93cyB9XG4gICAgICAgICAgICAgICAgICBwbGFjZWhvbGRlcj17IHBsYWNlaG9sZGVyIH1cbiAgICAgICAgICAgICAgICAgIGNsYXNzTmFtZT17IGNsYXNzbmFtZXMoJ2FwLXRleHQgYXAtdGV4dC1tdWx0aXBsZScsIGNsYXNzTmFtZSkgfVxuICAgICAgICAgICAgICAgICAgdmFsdWU9eyB2YWx1ZSB9XG4gICAgICAgICAgICAgICAgICB7IC4uLmhhbmRsZXJzIH1cbiAgICAgICAgICAgICAgICAgIG9uRm9jdXM9eyBudWxsIH1cbiAgICAgICAgPlxuICAgICAgPC90ZXh0YXJlYT5cbiAgICAgIClcbiAgICB9IGVsc2Uge1xuICAgICAgcmV0dXJuIChcbiAgICAgICAgPGlucHV0IGF1dG9Gb2N1cz17IGF1dG9Gb2N1cyB9XG4gICAgICAgICAgICAgICBpZD17IGlkIH1cbiAgICAgICAgICAgICAgIG5hbWU9eyBuYW1lIH1cbiAgICAgICAgICAgICAgIHBsYWNlaG9sZGVyPXsgcGxhY2Vob2xkZXIgfVxuICAgICAgICAgICAgICAgY2xhc3NOYW1lPXsgY2xhc3NuYW1lcygnYXAtdGV4dCcsIGNsYXNzTmFtZSl9XG4gICAgICAgICAgICAgICB2YWx1ZT17IHZhbHVlIH1cbiAgICAgICAgICAgICAgIGF1dG9Db21wbGV0ZT17IGF1dG9Db21wbGV0ZSB9XG4gICAgICAgICAgICAgICB7IC4uLmhhbmRsZXJzIH1cbiAgICAgICAgICAgICAgIHR5cGU9J3RleHQnXG4gICAgICAgIC8+XG4gICAgICApXG4gICAgfVxuICB9XG5cbiAgc3RhdGljIENhbmRpZGF0ZUxpc3QgKHsgc3VnZ2VzdGluZywgY2FuZGlkYXRlcywgc2VsZWN0ZWRDYW5kaWRhdGUsIG11bHRpbGluZSwgaGFuZGxlcnMgfSkge1xuICAgIGlmICghc3VnZ2VzdGluZykge1xuICAgICAgcmV0dXJuIG51bGxcbiAgICB9XG5cbiAgICBpZiAoIWNhbmRpZGF0ZXMpIHtcbiAgICAgIHJldHVybiBudWxsXG4gICAgfVxuXG4gICAgaWYgKCFjYW5kaWRhdGVzLmxlbmd0aCkge1xuICAgICAgcmV0dXJuIG51bGxcbiAgICB9XG5cbiAgICBpZiAobXVsdGlsaW5lKSB7XG4gICAgICBjb25zb2xlLndhcm4oJ1tBcFRleHRdIENhbiBub3QgdXNlIGNhbmRpZGF0ZXMgd2l0aCBtdWx0aWxpbmUgaW5wdXQuJylcbiAgICAgIHJldHVybiBudWxsXG4gICAgfVxuXG4gICAgcmV0dXJuIChcbiAgICAgIDx1bCBjbGFzc05hbWU9J2FwLXRleHQtY2FuZGlkYXRlLWxpc3QnPlxuICAgICAgICB7XG4gICAgICAgICAgY2FuZGlkYXRlcy5tYXAoKGNhbmRpZGF0ZSkgPT5cbiAgICAgICAgICAgIDxsaSBrZXk9eyBjYW5kaWRhdGUgfVxuICAgICAgICAgICAgICAgIGNsYXNzTmFtZT17IGNsYXNzbmFtZXMoJ2FwLXRleHQtY2FuZGlkYXRlLWxpc3QtaXRlbScsIHtcbiAgICAgICAgICAgICAgICAgICdhcC10ZXh0LWNhbmRpZGF0ZS1saXN0LWl0ZW0tc2VsZWN0ZWQnOiBjYW5kaWRhdGUgPT09IHNlbGVjdGVkQ2FuZGlkYXRlXG4gICAgICAgICAgICAgICAgfSkgfT5cbiAgICAgICAgICAgICAgPGEgeyAuLi5oYW5kbGVycyB9XG4gICAgICAgICAgICAgICAgIGRhdGEtdmFsdWU9eyBjYW5kaWRhdGUgfT57IGNhbmRpZGF0ZSB9PC9hPlxuICAgICAgICAgICAgPC9saT5cbiAgICAgICAgICApXG4gICAgICAgIH1cbiAgICAgIDwvdWw+XG4gICAgKVxuICB9XG59XG5cbk9iamVjdC5hc3NpZ24oQXBUZXh0LCB7XG4gIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tXG4gIC8vIFNwZWNzXG4gIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tXG5cbiAgcHJvcFR5cGVzOiB7XG4gICAgLyoqIE5hbWUgb2YgdGV4dCBpbnB1dCAqL1xuICAgIG5hbWU6IHR5cGVzLnN0cmluZyxcbiAgICAvKiogVmFsdWUgb2YgdGV4dCBpbnB1dCAqL1xuICAgIHZhbHVlOiB0eXBlcy5zdHJpbmcsXG4gICAgLyoqIFBsYWNlaG9sZGVyIHRleHQgKi9cbiAgICBwbGFjZWhvbGRlcjogdHlwZXMuc3RyaW5nLFxuICAgIC8qKiBOdW1iZXIgb2Ygcm93cyAqL1xuICAgIHJvd3M6IHR5cGVzLm51bWJlcixcbiAgICAvKiogU2VsZWN0YWJsZSBjYW5kaWRhdGUgdGV4dCAqL1xuICAgIGNhbmRpZGF0ZXM6IHR5cGVzLmFycmF5T2YodHlwZXMuc3RyaW5nKSxcbiAgICAvKiogQ2FsbGJhY2sgZm9yIGVudHJ5IGtleSBwcmVzcyAqL1xuICAgIG9uRW50ZXI6IHR5cGVzLmZ1bmNcbiAgfSxcblxuICBkZWZhdWx0UHJvcHM6IHtcbiAgICBuYW1lOiAnJyxcbiAgICB2YWx1ZTogJycsXG4gICAgcGxhY2Vob2xkZXI6ICcnLFxuICAgIHJvd3M6IDEsXG4gICAgY2FuZGlkYXRlczogbnVsbFxuICB9XG5cbn0pXG5cbmV4cG9ydCBkZWZhdWx0IEFwVGV4dFxuIl19